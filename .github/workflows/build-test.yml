name: FTMS CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-scan:
    name: Build, Test & Analyze
    runs-on: self-hosted

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Enforce Maven Wrapper Permissions
        shell: pwsh
        run: |
          Write-Host "Granting execution rights to mvnw..."
          if (Test-Path "./mvnw") {
            git update-index --chmod=+x mvnw
            Write-Host "Permissions applied successfully."
          } else {
            Write-Host "mvnw not found, skipping permission update."
          }

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Project with Maven
        shell: pwsh
        run: mvn clean install -DskipTests=false

      - name: Run SonarQube Scan
        shell: pwsh
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000
        run: |
          Write-Host "Initiating SonarQube scan..."
          mvn sonar:sonar `
            -Dsonar.projectKey=ftms-enterprise `
            -Dsonar.host.url=$env:SONAR_HOST_URL `
            -Dsonar.login=$env:SONAR_TOKEN

      - name: Verify SonarQube Quality Gate
        shell: pwsh
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000
        run: |
          Write-Host "Waiting for SonarQube quality gate status..."
          Start-Sleep -Seconds 30
          $response = Invoke-RestMethod -Uri "$env:SONAR_HOST_URL/api/qualitygates/project_status?projectKey=ftms-enterprise" -Headers @{Authorization=("Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$env:SONAR_TOKEN:")))}
          $status = $response.projectStatus.status
          Write-Host "Quality Gate Status: $status"
          if ($status -ne "OK") {
            Write-Host "❌ Quality gate failed"
            exit 1
          }
          Write-Host "✅ Quality gate passed"
