name: FTMS CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-scan:
    name: Build, Test & Analyze
    runs-on: self-hosted

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Enforce Maven Wrapper Permissions
        shell: cmd
        run: |
          echo Granting execution rights to mvnw...
          if exist mvnw (
            git update-index --chmod=+x mvnw
            echo Permissions applied successfully.
          ) else (
            echo mvnw not found, skipping permission update.
          )

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Project with Maven
        shell: cmd
        run: mvn clean install -DskipTests=false

      - name: Run SonarQube Scan
        shell: cmd
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000
        run: |
          echo Initiating SonarQube scan...
          mvn sonar:sonar ^
            -Dsonar.projectKey=ftms-backend ^
            -Dsonar.host.url=%SONAR_HOST_URL% ^
            -Dsonar.login=%SONAR_TOKEN%
      


      - name: Verify SonarQube Quality Gate
        shell: pwsh
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000
        run: |
          Write-Host "üïí Waiting for SonarQube analysis task completion..."
          Start-Sleep -Seconds 20

          # Updated location for SonarQube report file
          $reportFile = "target/sonar/report-task.txt"
          if (!(Test-Path $reportFile)) {
              Write-Error "‚ùå Sonar report-task.txt not found at $reportFile. Sonar scanner may have failed."
              exit 1
          }

          $taskId = (Select-String -Path $reportFile -Pattern "ceTaskId=(.*)").Matches.Groups[1].Value
          Write-Host "üìÑ SonarQube CE Task ID: $taskId"

          # Poll for background task completion
          $maxAttempts = 10
          for ($i = 1; $i -le $maxAttempts; $i++) {
              $taskResponse = Invoke-RestMethod -Uri "$env:SONAR_HOST_URL/api/ce/task?id=$taskId" `
                  -Headers @{Authorization=("Basic "+[Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$env:SONAR_TOKEN:")))} `
                  -UseBasicParsing

              $status = $taskResponse.task.status
              Write-Host "‚è≥ Attempt $i/$maxAttempts - Current task status: $status"

              if ($status -eq "SUCCESS") {
                  Write-Host "‚úÖ Background task completed successfully."
                  break
              } elseif ($status -eq "FAILED") {
                  Write-Error "‚ùå SonarQube background task failed."
                  exit 1
              }

              Start-Sleep -Seconds 15
          }

          # Fetch and validate Quality Gate
          $projectResponse = Invoke-RestMethod -Uri "$env:SONAR_HOST_URL/api/qualitygates/project_status?projectKey=ftms-backend" `
              -Headers @{Authorization=("Basic "+[Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$env:SONAR_TOKEN:")))} `
              -UseBasicParsing

          $qualityStatus = $projectResponse.projectStatus.status
          Write-Host "üèÅ Quality Gate Status: $qualityStatus"

          if ($qualityStatus -ne "OK") {
              Write-Error "‚ùå Quality Gate failed"
              exit 1
          }

          Write-Host "üéØ Quality Gate passed successfully!"