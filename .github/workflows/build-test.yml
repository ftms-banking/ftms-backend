name: FTMS CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-scan:
    name: Build, Test & Analyze
    runs-on: self-hosted
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Enable PowerShell Script Execution
        shell: pwsh
        run: |
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

      - name: Enforce Maven Wrapper Permissions
        run: |
            echo "Granting execution rights to mvnw..."
            chmod +x ./mvnw
            git update-index --chmod=+x mvnw || true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Project with Maven
        run: mvn clean install -DskipTests=false

      - name: Run SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000  # since SonarQube runs locally in Docker
        run: |
          mvn sonar:sonar ^
            -Dsonar.projectKey=ftms-enterprise ^
            -Dsonar.host.url=%SONAR_HOST_URL% ^
            -Dsonar.login=%SONAR_TOKEN%

      - name: Verify SonarQube Quality Gate
        shell: bash
        run: |
          echo "Waiting for SonarQube quality gate status..."
          sleep 30
          status=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=ftms-enterprise" | jq -r '.projectStatus.status')
          echo "Quality Gate Status: $status"
          if [ "$status" != "OK" ]; then
            echo "❌ Quality gate failed"
            exit 1
          fi
          echo "✅ Quality gate passed"
